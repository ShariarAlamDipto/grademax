# System Architecture - Further Pure Mathematics Integration

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE (Next.js)                     â”‚
â”‚  /generate page with multi-subject selector + topic table + preview  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND API (Next.js)                           â”‚
â”‚  - /api/worksheets/generate-v2 (creates worksheet)                  â”‚
â”‚  - /api/worksheets/[id]/download (downloads PDF)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE (Supabase)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   subjects   â”‚  â”‚    papers    â”‚  â”‚    pages     â”‚              â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â”‚  â”‚ 4PH1 Physics â”‚â†’ â”‚ 2024 May-Jun â”‚â†’ â”‚ Q1: CALC     â”‚              â”‚
â”‚  â”‚ 9FM0 Further â”‚  â”‚ 2023 Oct-Nov â”‚  â”‚ Q2: GRAPHS   â”‚              â”‚
â”‚  â”‚ 9MA0 Maths A â”‚  â”‚ Paper 1, 2   â”‚  â”‚ topics[]     â”‚              â”‚
â”‚  â”‚ 4MB1 Maths B â”‚  â”‚ QP + MS      â”‚  â”‚ confidence   â”‚              â”‚
â”‚  â”‚ WME1 Mech 1  â”‚  â”‚              â”‚  â”‚ difficulty   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â–²
                         â”‚ (ingestion pipeline)
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 INGESTION PIPELINE (Python)                          â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  page_based_ingest.py (Main Pipeline)                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚ 1. SPLIT   â”‚â†’ â”‚ 2. CLASSIFYâ”‚â†’ â”‚ 3. UPLOAD  â”‚â†’ Database   â”‚   â”‚
â”‚  â”‚  â”‚ split_pagesâ”‚  â”‚ classifier â”‚  â”‚ compress + â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  Batch Processors:                                                   â”‚
â”‚  - batch_process_physics.py                                          â”‚
â”‚  - batch_process_further_pure.py                                     â”‚
â”‚  - [future: batch_process_maths_a.py, etc.]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â–²
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CLASSIFICATION ENGINE (Python)                         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  symbol_aware_classifier.py                                  â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚   SIMPLE MODE       â”‚    â”‚  SYMBOL-AWARE MODE   â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  (Physics)          â”‚    â”‚  (Further Pure)      â”‚        â”‚   â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Keyword matching  â”‚    â”‚ â€¢ Symbol grammar     â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Single topic      â”‚    â”‚ â€¢ Pattern matching   â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Confidence score  â”‚    â”‚ â€¢ Hard floors        â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚ â€¢ Multi-topic        â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Config:             â”‚    â”‚ â€¢ Methods detection  â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ physics_topics.yaml â”‚    â”‚ â€¢ LLM fallback       â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚                      â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ 8 topics            â”‚    â”‚ Config:              â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚ further_pure.yaml    â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚                      â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚ 10 topics            â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚           â–²                             â–²                    â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚   â”‚
â”‚  â”‚                         â”‚                                    â”‚   â”‚
â”‚  â”‚                   Auto-detects mode                          â”‚   â”‚
â”‚  â”‚                   from YAML structure                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  LLM Fallback: Gemini 1.5 Flash (if confidence < 0.62)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â–²
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  RAW DATA (File System)                              â”‚
â”‚                                                                       â”‚
â”‚  data/raw/IGCSE/                                                     â”‚
â”‚    â”œâ”€â”€ Physics/                                                      â”‚
â”‚    â”‚   â”œâ”€â”€ 2024/May-Jun/Paper 1.pdf, Paper 1_MS.pdf                 â”‚
â”‚    â”‚   â””â”€â”€ 2023/Oct-Nov/Paper 2.pdf, Paper 2_MS.pdf                 â”‚
â”‚    â”‚                                                                  â”‚
â”‚    â”œâ”€â”€ FurtherPureMaths/                                             â”‚
â”‚    â”‚   â”œâ”€â”€ 2024/May-Jun/Paper 1.pdf, Paper 1_MS.pdf                 â”‚
â”‚    â”‚   â””â”€â”€ 2023/Oct-Nov/Paper 1.pdf, Paper 1_MS.pdf                 â”‚
â”‚    â”‚                                                                  â”‚
â”‚    â””â”€â”€ [Future: MathsA/, MathsB/, Mechanics1/]                       â”‚
â”‚                                                                       â”‚
â”‚  Watermark format: "PMT\nPhysics Â· 2024 Â· May/Jun Â· Paper 1 Â· QP"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Data Flow - Question Processing

```
RAW PDF
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. WATERMARK EXTRACTION             â”‚
â”‚ Extract: Subject, Year, Season      â”‚
â”‚ Normalize: May-Jun â†’ Jun            â”‚
â”‚ Map: Physics â†’ 4PH1                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PAGE SPLITTING                   â”‚
â”‚ - Detect question starts            â”‚
â”‚ - Extract QP pages                  â”‚
â”‚ - Find matching MS pages            â”‚
â”‚ Output: q1.pdf, q2.pdf, ...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. TEXT EXTRACTION                  â”‚
â”‚ PyMuPDF (fitz) extracts text        â”‚
â”‚ First 3000 chars for classification â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CLASSIFICATION                   â”‚
â”‚                                     â”‚
â”‚ Is symbol_grammar in config?        â”‚
â”‚      â†“YES            â†“NO            â”‚
â”‚ Symbol-Aware     Simple Mode        â”‚
â”‚      â”‚               â”‚              â”‚
â”‚      â–¼               â–¼              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ Normalizeâ”‚   â”‚ Keywords â”‚         â”‚
â”‚ â”‚ Symbols  â”‚   â”‚ Matching â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚      â–¼             â–¼                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ Detect  â”‚   â”‚ Score    â”‚         â”‚
â”‚ â”‚ Patternsâ”‚   â”‚ Topics   â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚      â–¼             â–¼                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ Score   â”‚   â”‚ Return   â”‚         â”‚
â”‚ â”‚ Topics  â”‚   â”‚ Primary  â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚      â–¼             â–¼                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚ Apply Hard Floors   â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â–¼                          â”‚
â”‚ Confidence < 0.62?                  â”‚
â”‚          â†“YES   â†“NO                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ LLM â”‚   â”‚ Return â”‚           â”‚
â”‚     â”‚ API â”‚   â”‚ Result â”‚           â”‚
â”‚     â””â”€â”€â”¬â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â–¼                            â”‚
â”‚   Return Result                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. PDF COMPRESSION                  â”‚
â”‚ JPEG quality 85                     â”‚
â”‚ ~33% size reduction                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. UPLOAD TO STORAGE                â”‚
â”‚ Bucket: question-pdfs               â”‚
â”‚ Path: subjects/{name}/pages/...     â”‚
â”‚ QP + MS uploaded                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. DATABASE INSERT                  â”‚
â”‚ pages table:                        â”‚
â”‚ - question_number                   â”‚
â”‚ - topics[] (array)                  â”‚
â”‚ - difficulty                        â”‚
â”‚ - confidence                        â”‚
â”‚ - qp_page_url                       â”‚
â”‚ - ms_page_url                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Classification Decision Tree

```
Question Text
     â”‚
     â–¼
Load YAML config
     â”‚
     â–¼
Has 'symbol_grammar'?
     â”œâ”€YESâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                 â–¼
     â”‚                       SYMBOL-AWARE MODE
     â”‚                                 â”‚
     â”‚                                 â–¼
     â”‚                       1. Normalize text
     â”‚                          Î¸ â†’ theta
     â”‚                          xÂ² â†’ x^2
     â”‚                          Ã— â†’ *
     â”‚                                 â”‚
     â”‚                                 â–¼
     â”‚                       2. Extract symbols
     â”‚                          âˆ« â†’ integrals
     â”‚                          d/dx â†’ derivatives
     â”‚                          sin() â†’ trig_funcs
     â”‚                                 â”‚
     â”‚                                 â–¼
     â”‚                       3. Score each topic
     â”‚                          Lexical: 35%
     â”‚                          Symbols: 45% â­
     â”‚                          Layout: 5%
     â”‚                          Co-tag: 15%
     â”‚                                 â”‚
     â”‚                                 â–¼
     â”‚                       4. Apply hard floors
     â”‚                          If âˆ« present
     â”‚                          â†’ CALC min 0.62
     â”‚                                 â”‚
     â”‚                                 â–¼
     â”‚                       5. Check confidence
     â”‚                          Max < 0.62?
     â”‚                          â†“YES    â†“NO
     â”‚                        LLM    Return
     â”‚                                 â”‚
     â”‚                                 â–¼
     â”‚                       6. Return multi-topic
     â”‚                          [{id, conf, evidence},
     â”‚                           {id, conf, evidence}]
     â”‚
     â””â”€NOâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â–¼
                              SIMPLE MODE
                                      â”‚
                                      â–¼
                           1. Extract keywords
                              "velocity"
                              "acceleration"
                              "motion"
                                      â”‚
                                      â–¼
                           2. Match to topics
                              Kinematics: 3/5 âœ…
                              Forces: 1/5 âŒ
                                      â”‚
                                      â–¼
                           3. Score topics
                              matches/total
                                      â”‚
                                      â–¼
                           4. Return primary
                              {topic: "1",
                               confidence: 0.82,
                               difficulty: "medium"}
```

## ğŸ“Š Topic Coverage Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subject  â”‚ Code               â”‚ Topics         â”‚ Mode         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Physics  â”‚ 4PH1               â”‚ 8              â”‚ Simple       â”‚
â”‚          â”‚                    â”‚ Kinematics     â”‚ Keywords     â”‚
â”‚          â”‚                    â”‚ Forces         â”‚              â”‚
â”‚          â”‚                    â”‚ Energy         â”‚              â”‚
â”‚          â”‚                    â”‚ Waves          â”‚              â”‚
â”‚          â”‚                    â”‚ Electricity    â”‚              â”‚
â”‚          â”‚                    â”‚ Magnetism      â”‚              â”‚
â”‚          â”‚                    â”‚ Nuclear        â”‚              â”‚
â”‚          â”‚                    â”‚ Matter         â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Further  â”‚ 9FM0               â”‚ 10             â”‚ Symbol-Aware â”‚
â”‚ Pure     â”‚                    â”‚ LOGS (ln, e^x) â”‚ Patterns     â”‚
â”‚ Maths    â”‚                    â”‚ QUAD (axÂ²+bx+c)â”‚ Hard floors  â”‚
â”‚          â”‚                    â”‚ IDENT (â‰¤, â‰¥)   â”‚ Multi-tag    â”‚
â”‚          â”‚                    â”‚ GRAPHS (y=f(x))â”‚ LLM fallback â”‚
â”‚          â”‚                    â”‚ SERIES (Î£, Sâ‚™) â”‚              â”‚
â”‚          â”‚                    â”‚ BINOMIAL (C(n,r))              â”‚
â”‚          â”‚                    â”‚ VECTORS (|a|Â·b)â”‚              â”‚
â”‚          â”‚                    â”‚ COORD ((x,y))  â”‚              â”‚
â”‚          â”‚                    â”‚ CALC (âˆ«, d/dx) â”‚              â”‚
â”‚          â”‚                    â”‚ TRIG (sin(AÂ±B))â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Maths A  â”‚ 9MA0               â”‚ 6 (planned)    â”‚ TBD          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Maths B  â”‚ 4MB1               â”‚ 5 (planned)    â”‚ TBD          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mech 1   â”‚ WME1               â”‚ 5 (planned)    â”‚ TBD          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Configuration Schema

```yaml
# YAML Config Structure

version: 2                          # Config version
subject:                            # Subject metadata
  code: "9FM0"
  name: "Further Pure Mathematics"
  board: "Edexcel"
  level: "IGCSE"

# OPTIONAL: Symbol grammar (triggers symbol-aware mode)
symbol_grammar:
  normalize:                        # Text normalizations
    superscripts_to_caret: true     # xÂ² â†’ x^2
    greek_letters_to_ascii_names: true  # Î¸ â†’ theta
    minus_to_ascii: true            # âˆ’ â†’ -
  
  tokens:                           # Pattern definitions
    derivatives: ["\\b(d/dx|dy/dx|f'\\(x\\))"]
    integrals: ["(âˆ«|\\bint\\b)"]
    # ... more tokens
  
  methods_catalog:                  # Method detection
    diff_chain: ["chain rule"]
    int_parts: ["integration by parts"]
    # ... more methods

schema:                             # Output schema
  tag_unit: "question"              # Tag whole question
  allow_multi_tag: true             # Multiple topics allowed
  output_format: "json"             # JSON response

scoring:                            # Scoring weights
  weights:
    lexical: 0.35                   # Keyword weight
    symbols: 0.45                   # Symbol weight (primary)
    layout: 0.05                    # Layout weight
    co_tag_prior: 0.15              # Related topic boost
  
  penalties:
    negative_hits: -0.22            # Penalty for negatives
    too_generic: -0.10              # Generic question penalty

symbol_hard_floors:                 # Minimum confidences
  CALC:
    any_of: ["derivatives", "integrals"]
    min_confidence: 0.62
  # ... more floors

layout_signals:                     # Visual elements
  axes_grid: ["axes", "graph paper"]
  # ... more signals

topics:                             # Topic definitions
  - id: CALC                        # Topic ID
    code: "9"                       # Database code
    name: "Calculus"                # Display name
    
    lexical:                        # Keyword patterns
      any: ["differentiate", "integrate", ...]
    
    symbols:                        # Symbol requirements
      any_sets: ["derivatives", "integrals", "limits"]
    
    structural_patterns:            # Regex patterns
      any: ["quotient rule", "product rule", ...]
    
    co_tag_prior:                   # Related topics
      GRAPHS: 0.10                  # Boost if GRAPHS also matches
      TRIG: 0.05                    # Boost if TRIG also matches
  
  # ... more topics
```

## ğŸš€ Deployment Checklist

```
Setup Phase:
[ ] 1. Config created: config/further_pure_topics.yaml
[ ] 2. Classifier created: scripts/symbol_aware_classifier.py
[ ] 3. Pipeline updated: scripts/page_based_ingest.py
[ ] 4. DB setup script: scripts/setup_further_pure_db.py
[ ] 5. Batch processor: scripts/batch_process_further_pure.py
[ ] 6. Test suite: scripts/test_classifier.py
[ ] 7. Documentation: docs/FURTHER_PURE_SETUP.md

Execution Phase:
[ ] 1. Run: python scripts/setup_further_pure_db.py
[ ] 2. Verify: Subject + 10 topics in database
[ ] 3. Test: python scripts/test_classifier.py (3/3 pass)
[ ] 4. Process: python scripts/batch_process_further_pure.py
[ ] 5. Verify: Questions in database with topics
[ ] 6. UI Check: /generate â†’ Select Further Pure â†’ Topics visible
[ ] 7. Generate: Create worksheet â†’ Verify PDF

Validation Phase:
[ ] 1. Physics still works (no regression)
[ ] 2. Further Pure questions classified correctly
[ ] 3. Multi-topic questions show evidence
[ ] 4. Confidence scores reasonable (> 0.60)
[ ] 5. PDFs compressed (~33% savings)
[ ] 6. Storage URLs working
[ ] 7. Worksheet generation working
```

---

**Ready to deploy!** ğŸ‰
